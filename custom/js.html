<html>

  <head>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/mode/javascript/javascript.min.js"></script>

<style>
canvas {border: 2px dotted #564b47}

.CodeMirror {
    border: 1px solid #eee;
    height: 150px;
    max-height:150px;
}

.CodeMirror-scroll {
    height: 150px;
    max-height:150px;
}
    </style>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"                 integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"></script>

  </head>

  <body>


    
    <h3>Glasgow Interactive JavaScript Online Editor</h3>

    <p>
      <!-- INSTRS -->
    </p>
    <p>
      Now type your JavaScript program in the box below.
    </p>

    <div id="codeblock" style="padding: 10px; background-color: gray;">

      <textarea id="textareacode" style="padding: 10px; background-color: 0xffffff;">/* insert JavaScript code here */

</textarea>

      <button class="button submit" onclick="executeCodeBlock()">run code <span class="fa fa-play" aria-hidden="true"></span></button>
      <button class="button save" onclick="dlSource()">download code <span class="fa fa-download" aria-hidden="true"></span></button>
      <button class="button reset" onclick="resetSource()">reset code <span class="fa fa-undo" aria-hidden="true"></span></button>
    </div>

    <div id="outputblock" style="padding: 10px; background-color: purple;">

      <div id="codeOutput" style="background-color: cornsilk; font-family: monospace; color: indigo;">
        <b>Code evaluation</b><br/>
        <div id="output">&nbsp;</div>
      </div>

      <div id="consoleOutput" style="background-color: azure; font-family: monospace; color: darkblue;">
        <b>Console output</b><br/>
        <div id="fakeConsole">&nbsp;</div>
        </div>
    </div>

    <div id="graphicsblock" style="padding: 10px; background-color: lightgray;">
      <h3>Array visualization</h3>
    <!-- draw the array here -->
    <canvas id="vizcanvas" width="300" height="300" style="background-color: white;"></canvas>

      <br />
          <a href="#" id="download" onclick="dlCanvas()" download="image.png"><button class="button save">download <span class="fa fa-download" aria-hidden="true"></span></button></a>&nbsp;
       <button class="button reset" onclick="resetCanvas()">reset<span class="fa fa-undo" aria-hidden="true"></span></button>

    </div>

    <script>
      function resetCanvas() {
          let canvas = document.getElementById("vizcanvas");
          let context = canvas.getContext('2d');
          context.clearRect(0, 0, canvas.width, canvas.height);
          context.moveTo(0,0);
      }
    </script>

    <script>
    <!-- PREAMBLE CODE -->
    </script>


    <script>



      var originalCode = `/* initial code */

`;
    
      //document.getElementById('textareacode').innerText = originalCode; // loses newlines?
      $('#textareacode').text(originalCode); // jquery preserves newlines?
      var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('textareacode'), {
          mode:  "javascript",
          lineNumbers: true,
      });

      function executeCodeBlock() {
          var codeFragment = myCodeMirror.getValue();
          var result = 'empty';
          try {
              result = eval(codeFragment);
              var numArrays = 0;
              // blank the canvas first
              resetCanvas();
              for (x in this) {
                  if (Array.isArray(this[x]) && this[x] != null) {
                      drawArray(x, numArrays, this[x]);
                      numArrays++;
                  }
              }
          }
          catch (e) {
              //if (e instanceof SyntaxError) {
              alert('CAUGHT ERROR: ' + e + "\n MESSAGE: " + e.message);
              // }
              // else {
              //          throw e;
              // }
          }
          document.getElementById('output').innerHTML = 'you executed this code: ' + codeFragment + '<br /> -> your result is: '+ '<font color="green">'+result+'</font>';
          return;
      }

      function resetSource() {
          myCodeMirror.setValue(originalCode);
      }

    function drawArray(name, n, arr) {
        if (arr == null) {
            console.error("null array!!");
            return;
        }
        var canvas = document.getElementById("vizcanvas");
        var ctx = canvas.getContext("2d");
        ctx.beginPath();
        let height = 50;
        let margin = 10;
        let startx = 10;
        let starty = 10 + ((height+10)*n);
        ctx.font = "20px Arial";
        ctx.fillText(name, startx, starty+height/2);
        startx += ctx.measureText(name).width + 10;
        for (let i=0; i<arr.length; i++) {
            let elementText = String(arr[i]);
            let elementTextWidth = ctx.measureText(elementText).width;
            let currentSide = (elementTextWidth+2*margin);
            ctx.rect(startx, starty, currentSide, height);
            ctx.fillText(elementText, startx+margin, starty+height/2);
            startx += currentSide;
        }
        ctx.strokeStyle = 'blue';
        ctx.stroke();
    }
    </script>


    <script>
    function dlCanvas() {
      var canvas = document.getElementById("vizcanvas");
      var dt = canvas.toDataURL('image/png');
      /* Change MIME type to trick the browser to downlaod the file instead of displaying it */
      dt = dt.replace(/^data:image\/[^;]*/, 'data:application/octet-stream');

      /* In addition to <a>'s "download" attribute, you can define HTTP-style headers */
    dt = dt.replace(/^data:application\/octet-stream/,
     'data:application/octet-stream;headers=Content-Disposition%3A%20attachment%3B%20filename=Canvas.png');

     document.getElementById("download").href = dt;
    };
   /*    document.getElementById("download").addEventListener('click', dlCanvas, false);*/
</script>

<script>
    
  function dlSource() {
    var sourceCode = myCodeMirror.getValue();
    var textToSaveAsBlob = new Blob([sourceCode], {type:"text/plain"});
    var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
    var fileNameToSaveAs = "code.js"

    var downloadLink = document.createElement("a");
    downloadLink.download = fileNameToSaveAs;
    downloadLink.innerHTML = "Download File";
    downloadLink.href = textToSaveAsURL;
    downloadLink.onclick = destroyClickedElement;
    downloadLink.style.display = "none";
    document.body.appendChild(downloadLink);

    downloadLink.click();
  }

function destroyClickedElement(event)
{
    document.body.removeChild(event.target);
}
    </script>

<script>
// for console capture
(function(){
var oldLog = console.log;
 var newLog = document.getElementById("fakeConsole");
    console.log = function (message) {
        newLog.innerHTML = message;
        oldLog.apply(console, arguments);
    };
})();

// convenience function
function log(x) {
    console.log(x);
}
</script>


  </body>
</html>
