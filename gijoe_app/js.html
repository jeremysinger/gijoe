<!DOCTYPE html>
<html lang="en">

  <head>

    <title>Glasgow Interactive JavaScript Online Editor</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/selection/mark-selection.min.js" integrity="sha512-aXjUoHbqle1lI5soSDU7OwjhVGBmenxiMyvaIEGI6mZUUyzSdxuqB1BrttHOSUa3/FenY6+qdZXNWkl0iy/x4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/selection/active-line.min.js" integrity="sha512-UNVAZmixdjeBtJVQcH5eSKXuVdzbSV6rzfTfNVyYWUIIDCdI9/G8/Z/nWplnSHXXxz9U8TA1BiJ1trK7abL/dg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.js" integrity="sha512-vmnoZMgVSaDE+VzynH2agDhizzixaoa27PqRWpqYXn4XOG/qxB/AFZOaRT/GIUbmVE1Fc/T1HGNiy/whbPz8uQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/javascript-hint.min.js" integrity="sha512-HB0sEfERI4Pe2z7rbx7JVGS0SEEGbnAbV+9X0bs3Hs9R/nCYartwJQg16bK1P0jPsMzbiXjT+kYNHYLCsHQ8HA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.css" integrity="sha512-OmcLQEy8iGiD7PSm85s06dnR7G7C9C0VqahIPAj/KHk5RpOCmnC6R2ob1oK4/uwYhWa9BF1GC6tzxsC8TIx7Jg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/edit/closebrackets.min.js" integrity="sha512-cCnOU69ESswPmMV3f9TR7WgctoJZliqGbJ8WeLn0VlUrngSsmtVopRf6OG/epbURGfNmY4RY6RzZ/mWkPQ/onw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/addon/runmode/runmode.min.js" integrity="sha512-uGLOqECti91iIJUClXd1nyZ4QtjscIitvdEApH2mX4AkmrpglCi6bdaF8sJhB3U2AkYKB1z1LIg3VP3OJImzMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/xml/xml.min.js" integrity="sha512-XPih7uxiYsO+igRn/NA2A56REKF3igCp5t0W1yYhddwHsk70rN1bbbMzYkxrvjQ6uk+W3m+qExHIJlFzE6m5eg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.60.0/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js"></script>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/code.css">
    <link rel="stylesheet" href="/static/css/output.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/autosave.css">
    <link rel="stylesheet" href="/static/css/tutorial.css">
    <link rel="stylesheet" href="/static/css/csv.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"		  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"></script>

    <!-- slider stuff -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="/static/css/turtleslider.css">
    <link rel="stylesheet" href="/static/css/progressbar.css">

    <!-- @jsinger parse tree and codegen libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/acorn/8.7.0/acorn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/acorn-walk@8.2.0/dist/walk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astring@1.8.1/dist/astring.min.js"></script>

  </head>

  <nav id="header" class="navbar navbar-expand-lg p-3 d-flex flex-wrap">
    <div id="header-logo" class="col-3 col-sm-4 px-2">
      <a href="https://www.gla.ac.uk/">
        <img id="logo" width="210" height="66" src="/static/static/university-of-glasgow-280.png" alt="University of Glasgow logo" class="d-none d-md-block">
        <img id="small-logo" width="294" height="64" src="/static/static/university-of-glasgow-min.png" alt="University of Glasgow logo" class="d-none d-sm-block d-md-none">
      </a>
    </div>

    <h3 class="text-center text-light col col-sm-4">Glasgow Interactive JavaScript Online Editor</h3>
    <small class="text-light text-center col col-sm-4 text-muted"> <!-- VERSION --> </small>
  </nav>

  <body>

    <div>
      <div class="px-4 pt-3" style="display: none"> 
        <p id="intro">
          <!-- INSTRS -->
        </p>
      </div>

      <div id="codeblock" class="row py-3 px-4 codeArea row-bottom-margin" style=" background-color: rgb(0,83,152);">
        <div id="tutorialArea" class="col pane">
          <div class="row justify-content-start">
            <div class="col-4">
              <h1 class="codeHeading">Instructions</h1>
            </div>
            <div id="pbsection" class="col pbsection">
              <div id="pb">
                <div class="step">
                  <div class="bullets">1</div>
                </div>
                <div class="step">
                  <div class="bullets">2</div>
                </div>
                <div class="step">
                  <div class="bullets last">3</div>
                </div>
              </div>
            </div>

            <!-- old stuff -->
            <div class="col-1">
              <h2 id="progressBarAlt" class="codeHeading"></h2>
            </div>
          </div>
          <div id="tutorialSpace"></div>
          <div id="tutorialControls" class="codeControls">
            <button class="button" id="tutorialBack"><< Back</button>
            <button class="button" id="tutorialForward">Forward >></button>
          </div>  
        </div>
        <div id="codeArea" class="col container pane pt-3 pt-lg-0">
          <div class="row row-cols-auto">
            <h1 class="codeHeading col">Code Editor</h1>
            <div class="col">
              <div id="autosave-area" class="success"></div>
            </div>  
          </div>
            
          <form id="sharedcode" method="post" action="https://jsfiddle.net/api/post/library/pure/" target="check">
            <textarea name="js" id="textareacode" style="padding: 10px; background-color: 0xffffff;">/* insert JavaScript code here */</textarea>
            <textarea name="html" id="htmlToShare" class="hidden"> /* insert the html turtle infrastructure code to be shared in jsfiddle */ </textarea>
	    <input type="text" name="title" class="hidden" value="JavaScript Project" />
	    <input type="text" name="description" class="hidden" value="Code exported from Coursera Computational Thinking in JavaScript" />
          </form>

          <div class="row container">
            <div class="handle codeControls col btn-group" role="group" aria-label="codeControls">

                <button id="submitcode" class="button submit" onclick="executeCodeBlock()"><span class="fa fa-play" aria-hidden="true"></span> Run </button>
                <button class="button reset" onclick="resetSource()"><span class="fa fa-undo" aria-hidden="true"></span> Reset </button>
                <button class="button save" onclick="dlSource()"> <span class="fa fa-download" aria-hidden="true"></span> Download </button>
                <button class="button share" form="sharedcode"> <span class="fa fa-share" aria-hidden="true"></span> Share </button>
                <div id="autoCompleteDiv">
                  <input type="checkbox" id="toggleAutoComplete" name="autoComplete">
                  <label for="autoComplete">Auto Complete</label>
                </div>
                
                <br>
            </div>
                
          </div>
              
        </div>
        
      </div>

      
      <div class="row row-bottom-margin">
        <div id="library-area" style="min-width: 600px; padding-right: 35px; padding-left: 10px; background-color: rgb(0,83,152); color: snow;" class="col-xl container-md py-3 py-lg-0 pane">
          <!-- LIBRARY-CONTROLS -->
          

        </div>
        

        
        <div id="outputblock" class="col container-md pane" style="background-color: azure;">
          <div id="outputwrap" class="row" style="background-color: azure;">
            <div id="codeOutput" class="col" style="background-color: rgb(246, 255, 255); font-family: monospace; color: #003865;">
              <h3>Code evaluation</h3><br/>
              <div id="output">&nbsp;</div>
            </div>
  
            <div id="consoleOutput" class="col" style="font-family: monospace; color: #003865;">
              <h3>Console Output</h3>
              <div id="fakeConsole">&nbsp;</div>
              <div id="testConsole" class="hidden">&nbsp;</div>
            </div>
          </div>
        </div>

        <p id=resetCode></p> <!-- Useful in order to manage the reset functionality -->
        <p id="test" class="hidden"> hi </p>

      </div>

        <script>
        <!-- PREAMBLE CODE -->
        </script>
        <script type="text/javascript" src="/static/js/domArea.js"></script>


        <script>
          const DEBUG = false;
          var csvTurtle = document.getElementById("csvTurtle");
          var timeout = false;
          var progressBarAlt = document.getElementById("progressBarAlt");
          console.log(progressBarAlt);
          var originalCode = `/* initial code */`;
          var saveCode =  `/* saved code */`;
          var tutorialFiles = parseInt(`/* tutorial_files */`);
          var initcodeFiles = parseInt(`/* initcode_files */`);
          var tutorialSettings = JSON.parse(`/* tutorial_settings */`);
          var libraries = JSON.parse(`/* library check */`);
          var csvString = "";
          var currentFile = 1;
          var turtleSpeed = 1000;

          var librarySpace = document.getElementById("library-area");

          if (!libraries) {
            librarySpace.style.display = "none";
          } else {
            librarySpace.style.display = "block";
          }

          if (csvTurtle && tutorialSettings.libraries.csvAndTurtle) {
            csvTurtle.style.display = "block";
          } else if (csvTurtle) {
            csvTurtle.style.display = "none";
          }

          var tutorialControls = document.getElementById("tutorialControls");
          if (tutorialFiles === 1) {
            tutorialControls.style.display = "none";
          } else {
            tutorialControls.style.display = "block";
          }

        
          //document.getElementById('textareacode').innerText = originalCode; // loses newlines?
          $('#textareacode').text(saveCode); // jquery preserves newlines?
          var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('textareacode'), {
            mode:  "javascript",
            lineNumbers: true,
            lineWrapping: true,
            hint: CodeMirror.hint.javascript,
            autoCloseBrackets: true,
            styleSelectedText: true
          });

          

        async function executeCodeBlock() {
          if (tutorialSettings.libraries.DOM) {
            resetDOM();
          }

          codeInput = myCodeMirror.getValue();
	  let rewriteAsyncCode = true;
          if (rewriteAsyncCode) {
            /* automatically annotate user
             * function definitions to be async,
             * so they can be called in GIJOE 
	     * framework with controlled delays
             */
	    let ast = acorn.Parser.parse(codeInput);
	    acorn.walk.simple(ast, {
	      FunctionDeclaration(node) {
		// make this user def'd function async...
		node.async = true;
	      }
	    });

            /* goSlowMode for turtle functions:
	     * we add sleep calls for some turtle calls
	     */
	    acorn.walk.ancestor(ast, { CallExpression(node, ancestors) {
	      if (node.callee.name === 'forward' ||
		  node.callee.name === 'left'     ||
		  node.callee.name === 'right') {

		if (DEBUG) {
		  console.log('found turtle fn: ' + node.callee.name);
		  console.assert(ancestors.length >=3 );
		}
                let parent = ancestors[ancestors.length-2];
		if (DEBUG) {
                  console.assert(parent.type == 'ExpressionStatement');
		}
		let enclBlock = ancestors[ancestors.length-3];
		let replaceIndex = enclBlock.body.indexOf(parent);
		if (DEBUG) {
		  console.assert(replaceIndex != -1);
		}

		// clone the call expr for a sleep call
		let sleepCall = Object.assign({}, node); // shallow clone
		sleepCall.callee = Object.assign({}, sleepCall.callee);
		sleepCall.callee.name = 'sleep';
		sleepCall.arguments = [{"type":"Identifier","start":0,"end":0,"name":"turtleSpeed"}];
		// clone the parent for a new (sleep) exprstmt
		let exprStmt = Object.assign({}, parent);
		exprStmt.expression = sleepCall;
		// clone the exprStmt for a new blockStmt
		let blockStmt = Object.assign({}, parent);
		blockStmt.type = 'BlockStatement';
		delete blockStmt.expression;
		blockStmt.body = [exprStmt,parent];
		// put the orig exprstmt (with the orig call) as stmt 1 in block
		// put a new exprstmt, with a new sleep as stmt 0 in block
		// put the new blockstmt in place of the orig expr stmt
		enclBlock.body[replaceIndex] = blockStmt;
	      }
	    }});

	    // add awaits for all function calls
	    acorn.walk.ancestor(ast, { CallExpression(node, ancestors) {
	      if (DEBUG) {
		console.assert(ancestors.length >=2 );
	      }
	      let parent = ancestors[ancestors.length-2];
	      if (DEBUG) {
                console.assert(parent.type === 'ExpressionStatement' ||
                               parent.type === 'VariableDeclarator');
	      }
	      let awaitExpr = Object.assign({}, node);  // shallow clone
	      awaitExpr.type = "AwaitExpression";
	      awaitExpr.argument = node;
	      // splice in await statement
	      if (parent.type === 'ExpressionStatement') {
		parent.expression = awaitExpr;
	      }
	      else if (parent.type === 'VariableDeclarator') {
		parent.init = awaitExpr;
	      }
	    }});

	    // convert the updated AST back into JS code
	    codeFragment = astring.generate(ast);

	    /* wrap the top-level user code in its own async function
	     * (since we are using await)
	     */
	    codeFragment = goSlowMode(codeFragment);
          } else {
	    // no changes required for timing delay control
            codeFragment = codeInput;
          }
          codeFragment = preventInfiniteLooping(codeFragment);

          if (DEBUG) {
	    console.log("rewritten code is: \n" + codeFragment);
	    console.log("\n");
	  }

          //goSlowButton and submitcodeButton should not be clickable while execution is happening
          const submitCodeButton = document.getElementById("submitcode");
          //only deactivate (and reactivate) the two buttons when on goSlowMode, do not otherwise
          if(isGoSlowOn){
            if(!submitCodeButton.disabled) {
              submitCodeButton.disabled = true;
            }
          }


          var result = 'empty';

          var runtimeError = false;
          autosaveArea.innerHTML = "<h4>Running...</h4>";
          
          try{
              clearConsole();
              if (rewriteAsyncCode) {
                result = eval(codeFragment).catch( handleError ).then( function () {  //only a catch like this can catch most errors

                if(isGoSlowOn){
                  if(submitCodeButton.disabled) {
                    submitCodeButton.disabled = false;
                  }
                }

                if(!timeout) {
                  autosaveArea.classList.remove("error");
                  autosaveArea.classList.add("success");
                  autosaveArea.innerHTML = "<h4>Well done!</h4>";

                  outputSuccess()

                } else {
                  autosaveArea.classList.remove("success");
                  autosaveArea.classList.add("error");
                  autosaveArea.innerHTML = "<h4>Your code has timed out</h4>";

                  outputArea.style.display = "block";
                  output.innerHTML = `<font color='red'>ERROR: InfiniteLoop<br></br>HINT: ${hintMap["InfiniteLoop"]}</font>`;
                }
                console.log( "---" );

                });
              } else { // (!rewriteAsyncCode)
                result = eval(codeFragment);

                if(!timeout) {
                  autosaveArea.classList.remove("error");
                  autosaveArea.classList.add("success");
                  autosaveArea.innerHTML = "<h4>Well done!</h4>";

                  outputSuccess()
                } else {
                  autosaveArea.classList.remove("success");
                  autosaveArea.classList.add("error");
                  autosaveArea.innerHTML = "<h4>Your code has timed out</h4>";

                  outputArea.style.display = "block";
                  output.innerHTML = `<font color='red'>ERROR: InfiniteLoop<br></br>HINT: ${hintMap["InfiniteLoop"]}</font>`;
                }

                console.log( "---" );
              }
              
          }
          catch (err) { //only a catch like this can catch syntax errors for whatever reason, but it can't catch any other one
            runtimeError = true;
            autosaveArea.classList.add("error");
            autosaveArea.innerHTML = "<h4>Error</h4>";
            handleError(err);
          }  
          finally { 
            if(isGoSlowOn){
              if(submitCodeButton.disabled) {
                submitCodeButton.disabled = false;
              }
            }
            if(!runtimeError && !timeout){
              document.getElementById('output').innerHTML = 'Your code executed successfully. ';  //'<br /> -> your result is: '+ '<font color="green">'+result+'</font>';
            }
          }

          // function resetSource() {
          //   myCodeMirror.setValue(originalCode);
          //   var data = JSON.stringify({
          //     code: originalCode
          //   });
          //   var http = new XMLHttpRequest();
          //   http.open("POST", "/autosave");
          //   http.setRequestHeader("Content-Type", "application/json");
          //   http.onload = function() {
          //     var autosaveArea = document.getElementById("autosave-area");
          //     autosaveArea.innerHTML = "<h4>Code Successfully Reset</h4>";
          //   }
          //   http.send(data);
          // }

          //scroll console to the last output
          var fakeConsole = document.getElementById("fakeConsole");
          fakeConsole.scrollTop = fakeConsole.scrollHeight;

          return;
        }

        function resetSource() {
          //Get list of init codes, get the right one with the var currentFile, if the currentFile number item does not exist then do not allow to reset :) or reset to a boilerplate
          currentCode = resetCode.innerHTML;
          myCodeMirror.setValue(currentCode);
          autosave();
        }

        function clearConsole() {
          var consoleElement = document.getElementById("fakeConsole");
          while (consoleElement.childNodes[1]) {
            consoleElement.removeChild(consoleElement.childNodes[1]);
          }
        }
        
        </script>

          <script>
          function dlCanvas() {
            var canvas = document.getElementById("imagecanvas");
            var dt = canvas.toDataURL('image/png');
            /* Change MIME type to trick the browser to downlaod the file instead of displaying it */
            dt = dt.replace(/^data:image\/[^;]*/, 'data:application/octet-stream');

            /* In addition to <a>'s "download" attribute, you can define HTTP-style headers */
          dt = dt.replace(/^data:application\/octet-stream/,
          'data:application/octet-stream;headers=Content-Disposition%3A%20attachment%3B%20filename=Canvas.png');

          document.getElementById("download").href = dt;
          };
        /*    document.getElementById("download").addEventListener('click', dlCanvas, false);*/
      </script>

      <script>
          
        function dlSource() {
          var sourceCode = myCodeMirror.getValue();
          var textToSaveAsBlob = new Blob([sourceCode], {type:"text/plain"});
          var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
          var fileNameToSaveAs = "code.js"

          var downloadLink = document.createElement("a");
          downloadLink.download = fileNameToSaveAs;
          downloadLink.innerHTML = "Download File";
          downloadLink.href = textToSaveAsURL;
          downloadLink.onclick = destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);

          downloadLink.click();
        }

      function destroyClickedElement(event)
      {
          document.body.removeChild(event.target);
      }
          </script>

      <script>
      // for console capture
      (function(){
        var oldLog = console.log;
        var pastLog = document.createElement("p"); 
        var newLog = document.getElementById("fakeConsole");
        var newElement;
        var test = document.getElementById("testConsole");
        console.log = function (message) {
          if(typeof(message) === "string") {
            if(message != ""){
              test.innerHTML = message;
            }
            messageList = message.split("\n");
            for (var i = 0; i < messageList.length; i++) {
              newElement = document.createElement("p");
              newElement.appendChild(document.createTextNode(messageList[i]));
              newLog.appendChild(pastLog);
              newLog.appendChild(newElement);
              pastLog.appendChild(newElement);
            }
          } else {
            newElement = document.createElement("p");
            newElement.appendChild(document.createTextNode(message));
            newLog.appendChild(pastLog);
            newLog.appendChild(newElement);
            pastLog.appendChild(newElement);
          }
          console.trace();
          oldLog.apply(console, arguments);
        };
      })();

      // convenience function
      function log(x) {
          console.log(x);
      }
      </script>
      
      <script type="text/javascript" src="/static/js/tutorial.js"></script>
      <script type="text/javascript" src="/static/js/autosave.js"></script>
      <script type="text/javascript" src="/static/js/turtleslider.js"></script>
      <script type="text/javascript" src="/static/js/goslow.js"></script>
      <script type="text/javascript" src="/static/js/progressbar.js"></script>
      <script type="text/javascript" src="/static/js/preventLooping.js"></script>
      <script type="text/javascript" src="/static/js/autocomplete.js"></script>
      <script type="text/javascript" src="/static/js/outputResize.js"></script>
      <script type="text/javascript" src="/static/js/errorLogging.js"></script>
      <script type="text/javascript" src="/static/js/shareToJsfiddle.js"></script>
      <script type="text/javascript" src="/static/js/getLineNumber.js"></script>
      <script type="text/javascript" src="/static/js/csv.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>


    </div>
  </body>
</html>
